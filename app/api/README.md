# API Документация

Полное описание всех эндпоинтов SKALDEngine Backend API.

**Base URL:** `http://127.0.0.1:8000`

---

## Аутентификация (`/auth`)

### POST `/auth/register`
Регистрация нового пользователя.

**Запрос:**
```json
{
  "email": "user@example.com",
  "password": "securepassword123"
}
```

**Ответ (201):**
```json
{
  "id": "uuid",
  "email": "user@example.com",
  "is_admin": false,
  "created_at": "2024-01-01T12:00:00"
}
```

**Ошибки:**
- `400` — Пользователь с такой почтой уже существует

---

### POST `/auth/login`
Вход в систему (получение JWT токена).

**Запрос (form-data):**
```
username: user@example.com
password: securepassword123
```

**Ответ (200):**
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer"
}
```

**Ошибки:**
- `400` — Неправильная почта или пароль

**Использование токена:**
Все защищенные эндпоинты требуют заголовок:
```
Authorization: Bearer <access_token>
```

---

## Пользователи (`/users`)

### GET `/users/me`
Получить информацию о текущем пользователе.

**Требуется:** Авторизация

**Ответ (200):**
```json
{
  "id": "uuid",
  "email": "user@example.com",
  "is_admin": false,
  "created_at": "2024-01-01T12:00:00"
}
```

---

## Персонажи (`/characters`)

### GET `/characters/`
Получить список всех персонажей.

**Требуется:** Авторизация

**Query параметры:**
- `skip` (int, default=0) — Пропустить N записей
- `limit` (int, default=20) — Максимум записей

**Ответ (200):**
```json
[
  {
    "id": "uuid",
    "name": "Элара",
    "avatar_url": "/static/uploads/avatar.jpg",
    "appearance": "Высокая эльфийка с серебристыми волосами",
    "personality_traits": "Мудрая, спокойная, загадочная",
    "speech_style": "Формальный, архаичный",
    "inner_world": "Скрывает древнюю тайну",
    "behavioral_cues": "Часто смотрит в даль"
  }
]
```

---

### GET `/characters/{character_id}`
Получить одного персонажа по ID.

**Требуется:** Авторизация

**Ответ (200):** Объект персонажа (см. выше)

**Ошибки:**
- `404` — Character not found

---

### POST `/characters/`
Создать нового персонажа.

**Требуется:** Права администратора

**Запрос:**
```json
{
  "name": "Элара",
  "avatar_url": "/static/uploads/avatar.jpg",
  "appearance": "Высокая эльфийка с серебристыми волосами",
  "personality_traits": "Мудрая, спокойная, загадочная",
  "speech_style": "Формальный, архаичный",
  "inner_world": "Скрывает древнюю тайну",
  "behavioral_cues": "Часто смотрит в даль"
}
```

**Ответ (201):** Созданный объект персонажа

---

### PUT `/characters/{character_id}`
Обновить персонажа.

**Требуется:** Права администратора

**Запрос:** Любые поля из CharacterUpdate (все опциональны)
```json
{
  "name": "Новое имя",
  "personality_traits": "Обновленные черты"
}
```

**Ответ (200):** Обновленный объект персонажа

**Ошибки:**
- `404` — Character not found

---

## Персоны пользователя (`/personas`)

### GET `/personas/`
Получить список персон текущего пользователя.

**Требуется:** Авторизация

**Query параметры:**
- `skip` (int, default=0)
- `limit` (int, default=10)

**Ответ (200):**
```json
[
  {
    "id": "uuid",
    "owner_id": "uuid",
    "name": "Странник",
    "description": "Молодой искатель приключений",
    "avatar_url": "/static/uploads/persona.jpg",
    "created_at": "2024-01-01T12:00:00"
  }
]
```

---

### POST `/personas/`
Создать новую персону.

**Требуется:** Авторизация

**Лимит:** Максимум 5 персон для обычных пользователей

**Запрос:**
```json
{
  "name": "Странник",
  "description": "Молодой искатель приключений",
  "avatar_url": "/static/uploads/persona.jpg"
}
```

**Ответ (201):** Созданная персона

**Ошибки:**
- `400` — Достигнут лимит (5 персон)

---

### GET `/personas/{persona_id}`
Получить одну персону по ID.

**Требуется:** Авторизация (только свои персоны)

**Ответ (200):** Объект персоны

**Ошибки:**
- `404` — Persona not found

---

### PUT `/personas/{persona_id}`
Обновить персону.

**Требуется:** Авторизация (только свои персоны)

**Запрос:** Любые поля (все опциональны)
```json
{
  "name": "Новое имя",
  "description": "Обновленное описание"
}
```

**Ответ (200):** Обновленная персона

---

### DELETE `/personas/{persona_id}`
Удалить персону.

**Требуется:** Авторизация (только свои персоны)

**Ответ (204):** Нет содержимого

---

### DELETE `/personas/`
Удалить все персоны текущего пользователя.

**Требуется:** Авторизация

**Ответ (204):** Нет содержимого

---

## Игровые сессии (`/sessions`)

### POST `/sessions/`
Начать новую игру.

**Требуется:** Авторизация

**Запрос:**
```json
{
  "character_id": "uuid",
  "persona_id": "uuid",
  "scenario_id": "uuid",  // опционально (null = режим песочницы)
  "language": "ru",
  "speech_style": "third_person",  // или "first_person"
  "relationship_context": "Вы старые друзья"  // опционально
}
```

**Ответ (201):**
```json
{
  "id": "uuid",
  "user_id": "uuid",
  "character_id": "uuid",
  "persona_id": "uuid",
  "scenario_id": "uuid",
  "mode": "scenario",  // или "sandbox"
  "language": "ru",
  "speech_style": "third_person",
  "character_name_snapshot": "Элара",
  "persona_name_snapshot": "Странник",
  "cached_system_prompt": "Системный промпт...",
  "current_step": 0,
  "created_at": "2024-01-01T12:00:00",
  "updated_at": null
}
```

**Ошибки:**
- `404` — Character/Persona/Scenario not found
- `403` — Нельзя использовать чужую персону

---

### GET `/sessions/`
Получить список своих игровых сессий (от новых к старым).

**Требуется:** Авторизация

**Query параметры:**
- `skip` (int, default=0)
- `limit` (int, default=20)

**Ответ (200):** Массив объектов сессий

---

### GET `/sessions/{session_id}`
Получить одну сессию по ID.

**Требуется:** Авторизация (только свои сессии)

**Ответ (200):** Объект сессии

**Ошибки:**
- `404` — Session not found
- `403` — Not your session

---

### POST `/sessions/{session_id}/chat`
Отправить сообщение в чат (получить ответ от ИИ).

**Требуется:** Авторизация (только свои сессии)

**Запрос:**
```json
{
  "content": "Привет! Как дела?"
}
```

**Ответ (200):**
```json
{
  "id": "uuid",
  "session_id": "uuid",
  "role": "assistant",
  "content": "Приветствую тебя, странник...",
  "parent_id": null,
  "is_active": true,
  "created_at": "2024-01-01T12:00:00"
}
```

**Логика:**
1. Сохраняет сообщение пользователя в БД
2. Ищет релевантные факты через RAG (ChromaDB)
3. Загружает последние 20 сообщений из истории
4. Отправляет запрос в Gemini API
5. Сохраняет ответ ИИ в БД
6. Возвращает ответ ИИ

**Ошибки:**
- `404` — Session not found

---

### GET `/sessions/{session_id}/messages`
Получить историю сообщений сессии.

**Требуется:** Авторизация (только свои сессии)

**Query параметры:**
- `skip` (int, default=0)
- `limit` (int, default=50)

**Ответ (200):**
```json
[
  {
    "id": "uuid",
    "session_id": "uuid",
    "role": "user",
    "content": "Привет!",
    "parent_id": null,
    "is_active": true,
    "created_at": "2024-01-01T12:00:00"
  },
  {
    "id": "uuid",
    "session_id": "uuid",
    "role": "assistant",
    "content": "Приветствую...",
    "parent_id": null,
    "is_active": true,
    "created_at": "2024-01-01T12:00:05"
  }
]
```

**Ошибки:**
- `404` — Session not found

---

## Знания персонажей / Lore (`/lore`)

### POST `/lore/{character_id}`
Добавить факт/знание для персонажа.

**Требуется:** Права администратора

**Запрос:**
```json
{
  "category": "fact",  // или "memory", "rule"
  "content": "Элара родилась в древнем лесу Сильвермун",
  "keywords": "Элара, Сильвермун, лес, рождение"  // опционально
}
```

**Ответ (201):**
```json
{
  "id": "uuid",
  "character_id": "uuid",
  "category": "fact",
  "content": "Элара родилась в древнем лесу Сильвермун",
  "keywords": "Элара, Сильвермун, лес, рождение"
}
```

**Примечание:** Факт автоматически индексируется в ChromaDB для RAG-поиска.

**Ошибки:**
- `404` — Character not found

---

### GET `/lore/{character_id}`
Получить все знания персонажа.

**Требуется:** Авторизация

**Ответ (200):** Массив объектов LoreItem

**Ошибки:**
- `404` — Character not found

---

### DELETE `/lore/{lore_id}`
Удалить факт.

**Требуется:** Права администратора

**Ответ (204):** Нет содержимого

**Примечание:** Факт также удаляется из ChromaDB.

**Ошибки:**
- `404` — Lore item not found

---

## Загрузка файлов (`/upload`)

### POST `/upload/`
Загрузить изображение (аватар персонажа/персоны).

**Требуется:** Авторизация (неявно, но рекомендуется)

**Запрос:** `multipart/form-data`
```
file: <binary image data>
```

**Допустимые форматы:** png, jpg, jpeg, gif, webp

**Ответ (200):**
```json
{
  "url": "/static/uploads/550e8400-e29b-41d4-a716-446655440000.jpg"
}
```

**Ошибки:**
- `400` — Недопустимый формат файла
- `500` — Ошибка сохранения файла

---

## Коды ошибок

| Код | Описание |
|-----|----------|
| 200 | OK — Успешный запрос |
| 201 | Created — Ресурс создан |
| 204 | No Content — Успешное удаление |
| 400 | Bad Request — Неверные данные |
| 401 | Unauthorized — Требуется авторизация |
| 403 | Forbidden — Недостаточно прав |
| 404 | Not Found — Ресурс не найден |
| 500 | Internal Server Error — Ошибка сервера |

---

## Роли пользователей

- **Обычный пользователь:**
  - Может создавать персоны (до 5 штук)
  - Может начинать игровые сессии
  - Может просматривать персонажей
  
- **Администратор (`is_admin=true`):**
  - Все права обычного пользователя
  - Может создавать/редактировать персонажей
  - Может добавлять/удалять знания (lore)
  - Нет лимита на персоны

---

## Примеры использования

### Полный флоу игры:

1. **Регистрация:**
```bash
POST /auth/register
{"email": "player@game.com", "password": "pass123"}
```

2. **Вход:**
```bash
POST /auth/login
username=player@game.com&password=pass123
# Получаем токен
```

3. **Создание персоны:**
```bash
POST /personas/
Authorization: Bearer <token>
{"name": "Герой", "description": "Смелый воин"}
```

4. **Выбор персонажа:**
```bash
GET /characters/
# Получаем список, выбираем character_id
```

5. **Начало игры:**
```bash
POST /sessions/
{"character_id": "...", "persona_id": "...", "language": "ru"}
# Получаем session_id
```

6. **Отправка сообщений:**
```bash
POST /sessions/{session_id}/chat
{"content": "Привет!"}
# Получаем ответ ИИ
```

7. **Просмотр истории:**
```bash
GET /sessions/{session_id}/messages
```

---

## Технические детали

### RAG (Retrieval Augmented Generation)
При отправке сообщения система:
1. Ищет в ChromaDB топ-3 релевантных факта о персонаже
2. Добавляет их в контекст как `[RECALLED MEMORY / FACTS]`
3. Отправляет в Gemini вместе с историей чата

### Системный промпт
Генерируется один раз при создании сессии и кэшируется в поле `cached_system_prompt`. Включает:
- Описание персонажа
- Описание персоны игрока
- Сценарий (если есть)
- Стиль речи и язык
- Контекст отношений

### История чата
Загружаются последние 20 сообщений для контекста. Сортировка от старых к новым.

---

## Поддержка

Swagger UI: `http://127.0.0.1:8000/docs`  
ReDoc: `http://127.0.0.1:8000/redoc`
